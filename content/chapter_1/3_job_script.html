<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Job scripts - Documentation on using HPC and containers for Machine Learning</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../index.html">Preliminary comments</a></li><li class="chapter-item expanded affix "><li class="part-title">Core book</li><li class="chapter-item expanded "><a href="../../content/chapter_1/0_introduction_to_hpc.html"><strong aria-hidden="true">1.</strong> Chapter 1: High Performance Computing (HPC)</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../content/chapter_1/1_introduction_to_sigma2.html"><strong aria-hidden="true">1.1.</strong> Introduction to Uninett Sigma2</a></li><li class="chapter-item expanded "><a href="../../content/chapter_1/2_navigating_in_hpc.html"><strong aria-hidden="true">1.2.</strong> Navigating in Sigma2</a></li><li class="chapter-item expanded "><a href="../../content/chapter_1/3_job_script.html" class="active"><strong aria-hidden="true">1.3.</strong> Job scripts</a></li></ol></li><li class="chapter-item expanded "><a href="../../content/chapter_2/0_introduction_containers.html"><strong aria-hidden="true">2.</strong> Chapter 2: Containers</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../content/chapter_2/1_singularity.html"><strong aria-hidden="true">2.1.</strong> Walk through Singularity</a></li><li class="chapter-item expanded "><a href="../../content/chapter_2/2_using_singularity.html"><strong aria-hidden="true">2.2.</strong> Using Singularity</a></li></ol></li><li class="chapter-item expanded "><a href="../../content/chapter_3/0_introduction.html"><strong aria-hidden="true">3.</strong> Chapter 3: File management on HPC clusters</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../content/chapter_3/1_copying.html"><strong aria-hidden="true">3.1.</strong> Copying files over to HPC clusters</a></li><li class="chapter-item expanded "><a href="../../content/chapter_3/2_filesystem.html"><strong aria-hidden="true">3.2.</strong> Using filesystem</a></li></ol></li><li class="chapter-item expanded "><a href="../../content/chapter_4/0_introduction.html"><strong aria-hidden="true">4.</strong> Chapter 4: Case study</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../content/chapter_4/1_setup_env.html"><strong aria-hidden="true">4.1.</strong> Setting up the environment</a></li><li class="chapter-item expanded "><a href="../../content/chapter_4/2_train_locally.html"><strong aria-hidden="true">4.2.</strong> Training model locally</a></li><li class="chapter-item expanded "><a href="../../content/chapter_4/3_train_sigma2.html"><strong aria-hidden="true">4.3.</strong> Training model on SIGMA2</a></li></ol></li><li class="chapter-item expanded "><a href="../../content/chapter_5/0_introduction.html"><strong aria-hidden="true">5.</strong> Chapter 5: Advanced topics</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../content/chapter_5/1_parallelising_workflow.html"><strong aria-hidden="true">5.1.</strong> Parallelising the workflow</a></li><li class="chapter-item expanded "><a href="../../content/chapter_5/2_ray_tune.html"><strong aria-hidden="true">5.2.</strong> Ray tune</a></li></ol></li><li class="chapter-item expanded "><a href="../../content/acknowledgments.html"><strong aria-hidden="true">6.</strong> Aknowledgments</a></li><li class="chapter-item expanded affix "><li class="part-title">Vocabulary</li><li class="chapter-item expanded "><a href="../../content/Acronyms.html"><strong aria-hidden="true">7.</strong> List of acronyns</a></li><li class="chapter-item expanded affix "><li class="part-title">Appendix</li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.</strong> Appendix A: list of referenced softwares & services</div></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Documentation on using HPC and containers for Machine Learning</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/NINAnor/91126800_ML_and_associated_tech" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="job-script-basics"><a class="header" href="#job-script-basics">Job script basics</a></h1>
<p>To run a job on the cluster involves creating a shell script called a <strong>job script</strong>. The job script is a plain-text file containing any number of commands, including your main computational task.</p>
<h2 id="anatomy-of-a-job-script"><a class="header" href="#anatomy-of-a-job-script">Anatomy of a job script</a></h2>
<p>A job script consists of a couple of parts, in this order:</p>
<ul>
<li>The first line, which is typically <code>#!/bin/bash</code> (the Slurm script does not have to be written in Bash, see below)</li>
<li>Parameters to the queue system (specified using the tag <code>#SBATCH</code>)</li>
<li>Commands to set up the execution environment</li>
<li>The actual commands you want to be run</li>
</ul>
<p>Note that lines starting with a <code>#</code> are ignored as comments, except lines that start with <code>#SBATCH</code> and the <strong>shebang</strong> (i.e. <code>#!/bin/bash</code>), which are not executed, but contain special instructions to the queue system. There can be as many <code>#SBATCH</code> as you want. Moreover, the <code>#SBATCH</code> lines must precede any commands in the script.</p>
<h3 id="sbatch-parameters"><a class="header" href="#sbatch-parameters">SBATCH parameters</a></h3>
<p>Which parameters are allowed or required depends the job type and cluster, but two parameters must be present in (almost) any job:</p>
<ul>
<li><strong>--account</strong>: specifies the project the job will run in. Required by all jobs.</li>
<li><strong>--time</strong>: specifies how long a job should be allowed to run. If it has not finished within that time, it will be cancelled.</li>
</ul>
<p>Other parameters that you will use on HPCs such as <code>SAGA</code>, <code>Betzy</code> or <code>Fram</code> include:</p>
<ul>
<li><strong>--ntasks</strong>: specifies the number of tasks to run on a node</li>
<li><strong>c--pus-per-task</strong>: allocate a specific number of CPUs to each task</li>
<li><strong>--mem-per-cpu</strong>: allocate a specific amount of memory per CPU and per task</li>
<li><strong>--partition</strong>: The nodes on a cluster is divided into sets, called partitions. Jobs are run in <strong>partitions</strong> that are specific to certain needs. For instance, if you want nodes with GPU you will have to specify <code>partition=accel</code>.</li>
</ul>
<p>And more rarely (if you have a very expensive task to run):</p>
<ul>
<li><strong>--nodes</strong>: number of nodes required</li>
<li><strong>--ntasks-per-node</strong>: number of processes or tasks to run on a single node</li>
</ul>
<h3 id="module-load"><a class="header" href="#module-load">Module load</a></h3>
<p>The <strong>module system</strong> is a concept available on most supercomputers, simplifying the use of different software (versions) in a precise and controlled manner. In most cases, an HPC has far more software installed than the average user will ever use and it would not been computationally efficient to have them loaded by default.</p>
<p>Note that with the use of container, you do not need the module system as all the different softwares should be built in your image. See <a href="./chapter_2/0_introduction_containers.html">Chapter 2</a>.</p>
<p>To get a list of available packages you can use:</p>
<pre><code>module avail
</code></pre>
<p>To load a module into your environment to start using an application you can use:</p>
<pre><code>module load package
</code></pre>
<p>For instance, if you want to load <code>Pytorch v. 1.4.0</code> with <code>python 3.7.4</code> use:</p>
<pre><code>module load PyTorch/1.4.0-fosscuda-2019b-Python-3.7.4
</code></pre>
<h2 id="example-1-basic-headers"><a class="header" href="#example-1-basic-headers">Example 1, basic headers:</a></h2>
<pre><code class="language-bash">#SBATCH --account=nnXXX
#SBATCH --job-name=Run_ML_model
#SBATCH --nodes=2
#SBATCH --time=1:0:0
#SBATCH --mem-per-cpu=4G
#SBATCH --ntasks=8 --cpus-per-task=10 --ntasks-per-node=4
</code></pre>
<p>This job will get 2 nodes, and run 4 processes (tasks) on each of them, each process is getting 10 cpus with 4GB of memory. The wall-time is 1 hours so each task will be able to compute for a maximum of 1 hour.</p>
<h2 id="example-2-train-a-cat--dog-classifier"><a class="header" href="#example-2-train-a-cat--dog-classifier">Example 2, train a cat / dog classifier:</a></h2>
<pre><code class="language-bash">#!/bin/bash

#SBATCH --account=nnXX --job-name=cat_dog_model
#SBATCH --partition=accel --gpus=1
#SBATCH --time=24:00:00
#SBATCH --mem-per-cpu=4G

cd /cluster/projects/nnXX/

# Load the modules
module load Anaconda3/2020.11

# Activate my environment
conda activate myenv

# Run the script
python main_scripts/train_model.py \
            --data_path data/kaggle_cats_dogs/train \
            --save_path data/saved_models/model.pt \
            --save_es data/saved_models/model_es.pt \
            --batch_size 128 \
            --lr 0.05 \
            --num_epoch 10
</code></pre>
<p>This job will run on a <strong>single node</strong> located in the <code>accel</code> partition as we ask for a GPU and run a <strong>single process</strong> (training the deep learning model). The <code>cd</code> indicates that we move to the project folder (under which our data are stored in <code>data</code>). We activate the module <code>Anaconda</code> so we can load our virtual environment using <code>conda activate</code>. Once the virtual environment is activated we can finally run the main script for training the model.</p>
<h2 id="example-3-a-generic-script"><a class="header" href="#example-3-a-generic-script">Example 3, a generic script:</a></h2>
<pre><code class="language-bash">
#!/bin/bash

# Job name:
#SBATCH --job-name=YourJobname
#
# Project:
#SBATCH --account=nnXXXXk
#
# Wall time limit:
#SBATCH --time=DD-HH:MM:SS
#
# Other parameters:
#SBATCH ...

## Set up job environment:
set -o errexit  # Exit the script on any error
set -o nounset  # Treat any unset variables as an error

module --quiet purge  # Reset the modules to the system default
module load SomeProgram/SomeVersion
module list

## Do some work:
YourCommands



</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../content/chapter_1/2_navigating_in_hpc.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../../content/chapter_2/0_introduction_containers.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../content/chapter_1/2_navigating_in_hpc.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../../content/chapter_2/0_introduction_containers.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="../../mermaid.min.js"></script>
        <script type="text/javascript" src="../../mermaid-init.js"></script>
    </body>
</html>
