<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Documentation on using HPC and containers for Machine Learning</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="index.html">Preliminary comments</a></li><li class="chapter-item expanded affix "><li class="part-title">Core book</li><li class="chapter-item expanded "><a href="content/chapter_1/0_introduction_to_hpc.html"><strong aria-hidden="true">1.</strong> Chapter 1: High Performance Computing (HPC)</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="content/chapter_1/1_introduction_to_sigma2.html"><strong aria-hidden="true">1.1.</strong> Introduction to Uninett Sigma2</a></li><li class="chapter-item expanded "><a href="content/chapter_1/2_navigating_in_hpc.html"><strong aria-hidden="true">1.2.</strong> Navigating in HPC servers</a></li></ol></li><li class="chapter-item expanded "><a href="content/chapter_2_Containers.html"><strong aria-hidden="true">2.</strong> Chapter 3: Containers</a></li><li class="chapter-item expanded "><a href="content/chapter_3_FileSystem.html"><strong aria-hidden="true">3.</strong> Chapter 4: Data management</a></li><li class="chapter-item expanded "><a href="content/chapter_4_Templates.html"><strong aria-hidden="true">4.</strong> Chapter 5: Case studies</a></li><li class="chapter-item expanded "><a href="content/acknowledgments.html"><strong aria-hidden="true">5.</strong> Aknowledgments</a></li><li class="chapter-item expanded affix "><li class="part-title">Vocabulary</li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.</strong> Glossary of terms and names</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.</strong> List of acronyns</div></li><li class="chapter-item expanded affix "><li class="part-title">Appendix</li><li class="chapter-item expanded "><div><strong aria-hidden="true">8.</strong> Appendix A: list of referenced softwares & services</div></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Documentation on using HPC and containers for Machine Learning</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<p>This document is a guide to get started with High Performance Computer clusters (HPCC) and more particularly <a href="https://www.sigma2.no/high-performance-computing">Uninett Sigma2's HPCC</a>. This guide aims at understanding the basic commands for navigating in the terminal of an HPCC, at helping running a <strong>job script</strong> and at managing files such as copying files from your local directory to the HPCC and using files that are stored remotely.</p>
<p>This document is the result of a Strategic Funding given by the <a href="https://www.nina.no/english/home">Norwegian Institute for Nature Research</a> (NINA). Please note that the document is <strong>not static</strong> and constantly subject to improvement based on feedbacks. You can contribute to improving the document by opening issues on the <a href="https://github.com/NINAnor/91126800_ML_and_associated_tech">GitHub repository</a> of this project.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="what-is-hpc-and-why-using-it"><a class="header" href="#what-is-hpc-and-why-using-it">What is HPC and why using it?</a></h1>
<p><strong>High performance computing</strong> (HPC) generally refers to processing complex calculations at high speeds across multiple servers in parallel. Those groups of servers are known as clusters and are composed of <strong>hundreds or even thousands of compute servers</strong> that have been connected through a network. </p>
<p>With the increased use of technologies like the Internet of Things (IoT), artificial intelligence (AI), and machine learning (ML), organizations are producing huge quantities of data, and they need to be able to process and use that data more quickly in real-time. To power the analysis of such large dataset it is often more practical / mandatory to make use of supercomputing. Supercomputing enables fast processing of data and training of complex algorithms such as neural networks for image and sound recognition.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="what-is-uninett-sigma2"><a class="header" href="#what-is-uninett-sigma2">What is Uninett Sigma2?</a></h1>
<p>Sigma2 is a <strong>non-profit</strong> company that provides services for high-performance computing and data storage to individuals and groups involved in research and education at all Norwegian universities and colleges, and other publicly funded organizations and projects (such as NINA). Their activities are financed by the <strong>Research Council of Norway (RCN)</strong> and the <strong>Sigma2 consortium partners</strong>, which are the universities in Oslo, Bergen, Trondheim and Tromsø. This collaboration goes by the name <strong>NRIS – Norwegian research infrastructure services</strong>. </p>
<p>Sigma2 owns <strong>four High Performance Computing (HPC) servers</strong> that have different configurations: <code>Betsy</code>, <code>Saga</code>, <code>Fram</code> and <code>LUMI</code>. Generally, if a project requires access to one or more <strong>Graphics processing units</strong> (GPUs) it is reasonable to apply for an access to <code>Saga</code>.</p>
<p>To apply for access to one of Sigma2 HPC please refer to <a href="https://www.sigma2.no/apply-e-infrastructure-resources">this page</a>. You will need to fill out a form describing your project, your experience with HPC and your computational needs (amount of CPU / GPU memory and storage your project will need).</p>
<p>For help regarding the application process contact <a href="mailto:benjamin.cretois@nina.no">Benjamin Cretois</a>, <a href="mailto:kjetil.grun@nina.no">Kjetil Grun</a> or <a href="mailto:francesco.frassinelli@nina.no">Francesco Frassinelli</a>.</p>
<h1 id="getting-started-with-sigma2"><a class="header" href="#getting-started-with-sigma2">Getting started with Sigma2</a></h1>
<p>After a successful application to an account on Sigma2 you will be given your <strong>username</strong> and will be able to log on the HPC terminal.</p>
<p>To access the HPC server you applied for (in our case it is <code>saga</code>). You can log in using the command <code>ssh</code> in <strong>Windows PowerShell</strong> or on a <strong>linux terminal</strong>: </p>
<pre><code class="language-bash">$ ssh username@saga.sigma2.no
</code></pre>
<p>The first time you log in, you will be asked to set your <strong>password</strong> which will have to be used at any subsequent connection to the HPC server.</p>
<div style="break-before: page; page-break-before: always;"></div><h2 id="2-navigating-in-sigma2s-hpc-server"><a class="header" href="#2-navigating-in-sigma2s-hpc-server">2. Navigating in Sigma2's HPC server</a></h2>
<h3 id="21-bash-crash-course"><a class="header" href="#21-bash-crash-course">2.1 bash crash course</a></h3>
<p>Communication between you and the HPC server is usually done through an interface named a <code>bash</code> and no <strong>Graphical User Interface (GUI)</strong> is provided</p>
<p>Here is how the bash looks like</p>
<pre><code>[bencretois@login-5.SAGA ~]$ 
</code></pre>
<p>Communicating with a bash requires learning a particular programming language, <strong>bash scripting</strong>. Below we provide a list of selected commands that will allow you to navigate in HPC server:</p>
<h4 id="change-directory"><a class="header" href="#change-directory">Change directory</a></h4>
<p><strong>Command:</strong></p>
<ul>
<li><code>cd + path to the directory</code> </li>
</ul>
<p><strong>Output:</strong></p>
<pre><code>[bencretois@login-5.SAGA ~]$ cd deepexperiments/
[bencretois@login-5.SAGA ~/deepexperiments]$
</code></pre>
<h4 id="get-to-the-previous-directory"><a class="header" href="#get-to-the-previous-directory">Get to the previous directory</a></h4>
<p><strong>Command:</strong></p>
<ul>
<li><code>cd ..</code> -&gt; get to the previous directory</li>
</ul>
<p><strong>Output:</strong></p>
<pre><code>[bencretois@login-5.SAGA ~/deepexperiments]$ cd ..
[bencretois@login-5.SAGA ~]$
</code></pre>
<h4 id="list-the-content-of-a-directory"><a class="header" href="#list-the-content-of-a-directory">List the content of a directory</a></h4>
<p><strong>Command:</strong></p>
<ul>
<li><code>ls</code> + name of a directory - Note that <code>ls</code> by default list the files of your current directory </li>
</ul>
<p><strong>Output:</strong></p>
<pre><code>[bencretois@login-5.SAGA ~/deepexperiments]$ ls

bash_cheatsheet.md   Dockerfile             list_ignore.txt  poetry.lock     runs            sync.sh
bayesianfy.ipynb     docker_run_jupyter.sh  models           pyproject.toml  scripts         utils
deepexperiments.sif  jobs
</code></pre>
<h4 id="get-the-path-of-your-current-directory"><a class="header" href="#get-the-path-of-your-current-directory">get the path of your current directory</a></h4>
<p><strong>Command:</strong></p>
<ul>
<li><code>pwd</code> </li>
</ul>
<p><strong>Output:</strong></p>
<pre><code>[bencretois@login-5.SAGA ~]$ pwd
/cluster/home/bencretois
</code></pre>
<h4 id="create-a-new-folder"><a class="header" href="#create-a-new-folder">Create a new folder</a></h4>
<p><strong>Command:</strong></p>
<ul>
<li><code>mkdir</code> + name of the folder you want to create</li>
</ul>
<p><strong>Output:</strong></p>
<pre><code>[bencretois@login-5.SAGA ~]$ mkdir new_folder
[bencretois@login-5.SAGA ~]$ ls
deepexperiments new_folder
</code></pre>
<h4 id="learning-more-bash-commands"><a class="header" href="#learning-more-bash-commands">Learning more bash commands</a></h4>
<p><em>Bash command</em>* are very well documented on Internet and if you wish to learn more you can begin <a href="https://www.educative.io/blog/bash-shell-command-cheat-sheet">here</a>.</p>
<h3 id="22-bash-commands-specific-to-sigma2s-hpc"><a class="header" href="#22-bash-commands-specific-to-sigma2s-hpc">2.2. Bash commands specific to Sigma2's HPC</a></h3>
<p>There are also some useful commands specific to your Sigma2 account:</p>
<h4 id="list-your-projects"><a class="header" href="#list-your-projects">List your projects</a></h4>
<p><strong>Command:</strong></p>
<p><code>projects</code> -&gt; list your projects</p>
<p><strong>Output:</strong></p>
<pre><code>[bencretois@login-5.SAGA ~]$ projects
nn5019k
</code></pre>
<h4 id="look-at-used-space-and-allocated-quota-for-your-projects"><a class="header" href="#look-at-used-space-and-allocated-quota-for-your-projects">Look at used space and allocated quota for your projects</a></h4>
<p><strong>Command:</strong></p>
<p><code>dusage</code> -&gt; . Note that <strong>space used</strong> is what you are currently using and <strong>quota</strong> is the limit. </p>
<p><strong>Output:</strong></p>
<pre><code>[bencretois@login-5.SAGA ~]$ dusage

dusage v0.1.4
                          path    backup    space used     quota    files      quota
------------------------------  --------  ------------  --------  -------  ---------
                      /cluster        no       5.6 GiB         -   38 819          -
      /cluster/home/bencretois       yes       4.6 GiB  20.0 GiB    1 311    100 000
/cluster/work/users/bencretois        no       0.0 KiB         -        0          -
     /cluster/projects/nn5019k       yes     938.2 MiB   1.0 TiB   37 508  1 000 000

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="containers"><a class="header" href="#containers">Containers</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="file-management-on-sigma2"><a class="header" href="#file-management-on-sigma2">File management on Sigma2</a></h1>
<h3 id="23-copy-files-over-to-sigma2"><a class="header" href="#23-copy-files-over-to-sigma2">2.3. Copy files over to Sigma2</a></h3>
<p><strong>A very important command</strong> is <code>scp</code> which allows you to copy files from your machine to the HPC machines. For instance you want to copy the script <code>train_model.py</code> over to <code>saga</code> in the folder <code>deepexperiments</code>, the command would be (using your relevant username and HPC):</p>
<pre><code>$ scp train_model.py bencretois@saga.sigma2.no:/deepexperiments/
</code></pre>
<p>With <code>scp</code> it is also possible to copy a folder over to the HPC machine, you will need to add the flag <code>-r</code> for this. For instance, if I want to copy the entire <code>deepexperiments</code> folder over to <code>saga</code> I can write:</p>
<pre><code>$ scp -r train_model.py bencretois@saga.sigma2.no:/deepexperiments/
</code></pre>
<h3 id="24-synchronizing-your-local-repository-with-your-remote-repository"><a class="header" href="#24-synchronizing-your-local-repository-with-your-remote-repository">2.4. Synchronizing your local repository with your remote repository</a></h3>
<p>Instead of copying all files from your local to remote folder you can synchronze the two folders with <code>rsync</code></p>
<pre><code>$ rsync -e ssh -avz ./local_repo user@server:/remote_repo
</code></pre>
<p><code>-a</code> is the archive option, i.e. syncs directories recursively while keeping permissions, symbolic links, ownership, and group settings. </p>
<p><code>-v</code> being the verbose option and prints the progress and status of the rsync command.</p>
<p><code>-z</code> compressing files during the transfer - speed up the sync.</p>
<p><code>-e</code> is used to specify the remote shell to use, <code>ssh</code> in our case.</p>
<p>It is also possible to use the option <code>--exclude</code> to exclude some file from synchronisation:</p>
<pre><code>$ rsync -e ssh -avz --exclude &quot;file.txt&quot; ./local_repo user@server:/remote_repo
</code></pre>
<p>However, in some cases there are files that we do not want to send to the remote repository. In these cases with can generate and <code>.txt</code> file containing a list of files to exclude.</p>
<pre><code>$ rsync -e ssh -avz --exclude-from{&quot;list_ignore.txt&quot;} ./local_repo user@server:/remote_repo
</code></pre>
<p>With <code>list_ignore.txt</code>:</p>
<pre><code>folder1
file1.txt
folder2
</code></pre>
<pre><code>def doConnection(connection_string):

    myfs = fs.open_fs(connection_string)
    return myfs
</code></pre>
<pre><code>def walk_audio(filesystem, input_path):
    # Get all files in directory with os.walk
    walker = filesystem.walk(input_path, filter=['*.wav', '*.flac', '*.mp3', '*.ogg', '*.m4a', '*.WAV', '*.MP3'])
    for path, dirs, flist in walker:
        for f in flist:
            yield fs.path.combine(path, f.name)
</code></pre>
<pre><code>def parseInputFiles(filesystem, input_path):

    files = []

    for index, audiofile in enumerate(walk_audio(filesystem, input_path)):
        files.append(audiofile)
            
    print('Found {} files for training'.format(len(files)))

    return files
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="templates"><a class="header" href="#templates">Templates</a></h1>
<h2 id="3-running-scripts-on-sigma2"><a class="header" href="#3-running-scripts-on-sigma2">3. Running scripts on Sigma2</a></h2>
<h3 id="31-anatomy-of-a-job-script"><a class="header" href="#31-anatomy-of-a-job-script">3.1. Anatomy of a job script</a></h3>
<p>To run a job on a SIGMA2 server we need to create a shell script called a job script. The job script is a plain-text file containing any number of commands, including your main computational task</p>
<h3 id="32-description-of-job-scripts"><a class="header" href="#32-description-of-job-scripts">3.2. Description of job scripts</a></h3>
<h2 id="using-docker-on-sigma2"><a class="header" href="#using-docker-on-sigma2">Using docker on SIGMA2</a></h2>
<ol>
<li>Introduction to docker</li>
<li>Build your custom docker image</li>
<li>Introduction to singularity</li>
<li>Run your script in a docker container</li>
</ol>
<h2 id="machine-learning-workflow"><a class="header" href="#machine-learning-workflow">Machine learning workflow</a></h2>
<ol>
<li>Structuring the ML project</li>
</ol>
<p>First of all, we need to differentiate the <strong>development space</strong> &amp; the <strong>data space</strong>. Usually, HPCs allocate a large amount of disk storage capacity in a specific place (i.e. <code>/cluster/projects/</code> for SAGA) and a smaller amount of disk storage capacity to store the scripts used to run an analysis (i.e. <code>/cluster/home/</code>)</p>
<p>For instance, for this specific project (nn5019k) we have 20GB of space in <code>/cluster/home/bencretois</code> and 1TB in <code>/cluster/projects/nn5019k</code> as displayed with the command <code>dusage</code> below:</p>
<pre><code>[bencretois@login-5.SAGA ~]$ dusage

dusage v0.1.4
                          path    backup    space used     quota    files      quota
------------------------------  --------  ------------  --------  -------  ---------
                      /cluster        no       5.6 GiB         -   38 819          -
      /cluster/home/bencretois       yes       4.6 GiB  20.0 GiB    1 311    100 000
/cluster/work/users/bencretois        no       0.0 KiB         -        0          -
     /cluster/projects/nn5019k       yes     938.2 MiB   1.0 TiB   37 508  1 000 000

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="acknowlegments"><a class="header" href="#acknowlegments">Acknowlegments</a></h1>
<p>This document would not have been possible without the inputs of Francesco Frassinelli, Kjetil Grun and Stig Clausen.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script type="text/javascript">
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="mermaid.min.js"></script>
        <script type="text/javascript" src="mermaid-init.js"></script>

        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </body>
</html>
